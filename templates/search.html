{% extends "main_bootstrap.html" %}

{% block head %}

{{ super() }}

<!--<link rel="stylesheet" href="//cdn.datatables.net/plug-ins/1.10.6/integration/bootstrap/3/dataTables.bootstrap.css"/>-->
<link rel="stylesheet" href="/static/__shared/external/dataTables.bootstrap.css"/>

<!--<script type="text/javascript" language="javascript" src="//cdn.datatables.net/1.10.6/js/jquery.dataTables.min.js"></script>-->
<!--<script type="text/javascript" language="javascript" src="//cdn.datatables.net/plug-ins/1.10.6/integration/bootstrap/3/dataTables.bootstrap.js"></script>-->
<script type="text/javascript" language="javascript" src="/static/__shared/external/jquery.dataTables.min.js"></script>
<script type="text/javascript" language="javascript" src="/static/__shared/external/dataTables.bootstrap.js"></script>

<!--<script src="//code.jquery.com/ui/1.11.4/jquery-ui.min.js"></script>-->
<script src="/static/__shared/external/jquery-ui.min.js"></script>

<script src="/static/__shared/external/jquery.selectBoxIt.min.js"></script>
<link rel="stylesheet" href="/static/__shared/external/jquery.selectBoxIt.css"/>

<link href="/static/__shared/external/bootstrap-switch.css" rel="stylesheet">
<script src="/static/__shared/external/bootstrap-switch.js"></script>

<style>
    table.dataTable td, table.dataTable th {
        font-size: 18px;
        font-weight: bold;
    }
    .dataTables_empty {
        text-align: center;
    }
    .wr-table {
        display: table;
        float: none;
        vertical-align: bottom;
        width: 100%;
        height: 100%;
        margin-left: 0px;
    }
    .wr-cell {
        display: table-cell;
        float: none;
        vertical-align: bottom;
        height: 100%;
        padding-left: 0px;
        padding-right: 0px;
    }
    .wr-cell:first-of-type {
        border-bottom: 1px solid #ddd;
    }
    .selectboxit-container {
        margin-top: -5px;
    }
    ul.nav-tabs span.glyphicon {
        margin-right: 4px;
    }
</style>

<script>
    function ts_to_date(ts)
    {
        if (ts.length < 14) {
            return ts;
        }

        var datestr = (ts.substring(0, 4) + "-" + 
                       ts.substring(4, 6) + "-" +
                       ts.substring(6, 8) + "T" +
                       ts.substring(8, 10) + ":" +
                       ts.substring(10, 12) + ":" +
                       ts.substring(12, 14) + "-00:00");

        return new Date(datestr).toLocaleString();
    }

    var pagesTable = undefined;
    var warcsTable = undefined;

    $(function() {
        $('a[data-toggle="tab"][href="#records"]').on('show.bs.tab', show_pages);
        $('a[data-toggle="tab"][href="#files"]').on('show.bs.tab', show_warcs);

        // Tab Nav
        $('#thetab a').click(function (e) {
            e.preventDefault();
            $(this).tab('show');
            if (e.target.hash) {
                window.location.hash = e.target.hash;
            }
        });

        var start_tab = "#records";

        if (window.location.hash.match('#')) {
            start_tab = window.location.hash;
        }

        $('#thetab a[href=' + start_tab +']').tab('show');
        
        {% if can_admin() %}
        // Public/Private
        $("#is_public").bootstrapSwitch();
         
        $("#is_public").on('switchChange.bootstrapSwitch', function(event, state) {
            $.ajax("/_setaccess?coll={{ path }}&public=" + state, {
                success: function() {},
                error: function() {
                    //$("#is_public").prop("checked", !state);
                    $("#is_public").bootstrapSwitch("toggleState", true)
                    console.log("err");
                }
            });
        });
        {% endif %}
    });

    function show_pages() {
        if (pagesTable) {
            //pagesTable.ajax.reload( null, false );
            return;
        }

        var prefix = "/{{ path }}/";

        var render_pages = function (data, type, full, meta) {
            var url = prefix;
            if (full['ts']) {
                url += full['ts'] + "/";
            }
            url += full['url'];

            if (meta.col == 0) {
                var title = data;
                if (!title) {
                    title = full['url'];
                }
            } else if (meta.col == 1) {
                var title = ts_to_date(data);
            } else {
                title = data;
            }

            return '<a href="' + url + '">' + title + '</a>';
        }

        pagesTable = $("#pageTable").DataTable( {
            "ajaxSource": "/_listpages?coll={{ path }}",
            "order": [[ 1, "desc" ]],
            "columns": [
                { "data": "title" },
                { "data": "ts" },
            ],
            "columnDefs": [ {
                "targets": [0, 1],
                "render": render_pages,
            }],
            "language": {
                "emptyTable": "No pages have been recorded in this collection yet"
            }
        });

        // Select
        $("#pageTable_length select").selectBoxIt({native: true});
    }

    function show_warcs() {
        if (warcsTable) {
            return;
        }

        var prefix = "/{{ path }}/";

        var render_warcs = function (data, type, full, meta) {
            var url = prefix;

            url += "warcs/" + data;

            return '<a href="' + url + '">' + data + '</a>';
        }
        
        var render_size = function (data, type, full, meta) {
            if (type === "sort") {
                return data;
            }
            return format_bytes(data);
        }
        
        var render_time = function (data, type, full, meta) {
            if (type === "sort") {
                return data;
            }
            
            return new Date(data * 1000).toLocaleString();
        }

        warcsTable = $("#warcsTable").DataTable( {
            "ajaxSource": "/_files?user={{ user }}&coll={{ coll }}",
            "order": [[ 1, "desc" ]],
            "columns": [
                { "data": "name" },
                { "data": "mtime", type: "num" },
                { "data": "size", type: "num"},
            ],
            "columnDefs": [ {
                "targets": [0],
                "render": render_warcs,
            }, {
                "targets": [2],
                "render": render_size,
            }, {
                "targets": [1],
                "render": render_time,
            }
            ],
        });
    }
</script>
{% endblock %}


{% block content %}
<div class="row">
    <div class="page-header" style="margin-top: 10px">
        <h1 style="display: inline">{{ title | default(coll) }}&nbsp;<small>/{{ coll }}</small>
        </h1>
        <span style="font-size: 14px" class="pull-right">
            <div style="margin: 18px 20px; display: inline-block">
                <span class="glyphicon glyphicon-globe" style="margin-right: 4px"></span><span style="margin-right: 4px">Public?</span> 
                {% if can_admin() %}
                <input type="checkbox" id="is_public" {{ 'checked' if is_public else '' }} data-on-color="success" data-inverse="true" data-size="mini" data-on-text="YES" data-off-text="NO">
                {% else %}
                <b>{{ 'YES' if is_public else 'NO' }}</b>
                {% endif %}
            </div>
        </span>
    </div>
</div>
{% if can_write() %}
<div class="row" style="margin-bottom: 20px">
    <div class="col-md-offset-2 col-md-8">
        <form id="dorecord" onsubmit="return false">
            <div class="input-group">
                <input id="theurl" name="theurl" type="text" placeholder="Enter a url to record here" class="input-large form-control">
                <span class="input-group-btn">
                    <button class="btn btn-primary url-rec-play" type="submit" data-path-prefix="/{{path}}/record/">
                        <span class="glyphicon glyphicon-dot-lg"></span> <span>Record</span>
                    </button>
                </span>
            </div>
        </form>
    </div>
</div>
{% endif %}
<div class="row">
    <div>
        <!-- Nav tabs -->
        <ul id="thetab" class="nav nav-tabs" role="tablist">
            <li role="presentation">
                <a href="#records" aria-controls="pages" role="tab" data-toggle="tab">
                    <span class="glyphicon glyphicon-file"></span>Records
                </a>
            </li>
            {#
            <li role="presentation">
                <a href="#search" aria-controls="search" role="tab" data-toggle="tab">
                    <span class="glyphicon glyphicon-search"></span>Search
                </a>
            </li>
            #}
            {% if can_admin() %}
            <li role="presentation">
                <a href="#files" aria-controls="files" role="tab" data-toggle="tab">
                    <span class="glyphicon glyphicon-hdd"></span>Storage
                </a>
            </li>
            {#
            <li role="presentation">
                <a href="#settings" aria-controls="settings" role="tab" data-toggle="tab">
                    <span class="glyphicon glyphicon-cog"></span>Settings
                </a>
            </li>
            #}
            {% endif %}
        </ul>
    </div>
</div>


<div role="tabpanel" style="margin-top: 20px">
    <!-- Tab panes -->
    <div class="tab-content">
        <div role="tabpanel" class="tab-pane" id="records">
            <table id="pageTable" class="table table-striped table-bordered" cellspacing="0" width="100%">
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Recorded on</th>
                    </tr>
                </thead>
            </table>
        </div>
        <div role="tabpanel" class="tab-pane" id="search">Search</div>
        <div role="tabpanel" class="tab-pane" id="files">
            <table id="warcsTable" class="table table-striped table-bordered" cellspacing="0" width="100%">
                <thead>
                    <tr>
                        <th>Filename</th>
                        <th>Last Modified</th>
                        <th>Size</th>
                    </tr>
                </thead>
            </table>
        </div>
        <div role="tabpanel" class="tab-pane" id="files">Storage</div>
    </div>
</div>


{% endblock %}
